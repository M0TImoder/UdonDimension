Speckit Constitution
====================

0. 文脈
-------
Speckit は、予算が限られたロボコン／教育系チームでも実機を組み立てる前に運動性能・制御戦略・機構の実効性を高精度で検証できることを目的とした、Rust ベースのリアルタイム物理シミュレーション・検証基盤である。本書は Speckit プロジェクトの憲章として、到達すべき姿・意思決定原則・中長期ロードマップ・品質基準を定める。

1. ビジョンとゴール
-------------------
- **最終ゴール**: 主要な競技ロボットの構造・制御・センサ系を仮想空間で統合的に再現し、実機試作 0→1 の前段で定量的判断を行える環境を提供する。
- **価値指標**
  - 実機との差異が定量的に説明できる（±5% 以内の誤差を目指す）動力学挙動。
  - ファームウェア／制御ソフトをそのまま HIL/SIL で流し込める I/F。
  - 設計者・制御班・解析班が同じモデルを共有し、1 週間単位で設計サイクルを回せるワークフロー。

2. コア原則
-----------
- **リアリズム重視**: MuJoCo 等の実績あるエンジンを活用しつつ、摩擦・剛性・バックラッシュなどロボコン固有の非線形を補正モジュールで扱う。
- **Rust 中心の安全性**: 並列処理・リソース管理・拡張 API は Rust コアから提供し、`unsafe` 領域を FFI ラッパーに封じ込める。
- **モジュラリティ**: 機構モデル、制御ループ、センサ/アクチュエータ、環境シナリオは疎結合でホットスワップ可能にする。
- **アクセシビリティ**: GUI・テンプレート・学習教材を含め、工業高校～大学初級レベルでも扱える UX を目指す。
- **再現性・可観測性**: すべてのシミュレーションはバージョン化されたシナリオ記述・ログ・乱数シードを伴い、再走可能な形で保存する。

3. 想定ユーザーとユースケース
------------------------------
- 競技ロボット班の制御エンジニア（SIL/HIL、センサチューニング）
- 機構設計担当（CAD からのダイレクトインポート、機構干渉チェック）
- 教育機関・研究室（制御理論の教材、研究用拡張）
- コミュニティ開発者（プラグインやアルゴリズム共有）

4. システムアーキテクチャ概要
-----------------------------
1. **コア層 (Rust)**
   - 時間積分・スレッドスケジューリング・リソース管理
   - モデル記述（剛体・関節・アクチュエータ・材質）
   - ログ、設定、バージョン管理
   - Plugin/Extension API（`trait` ベース）
2. **物理エンジン層 (C / C++)**
   - MuJoCo もしくは PhysX を FFI 経由でラップ
   - カスタム接触モデル・軸剛性補正・ロボコン特有のギアモータモデル
3. **制御連携層 (Rust + Python)**
   - `pyo3` による Python バインディング、Jupyter 連携
   - Arduino / STM32 などのビルドと通信モジュール、SIL/HIL エミュレータ
   - ROS2 / DDS ブリッジ
4. **データ I/O 層**
   - Fusion 360 / STEP / URDF インポート
   - テレメトリ（CSV、Parquet、ROS bag）エクスポート
   - 設定ファイル（TOML / YAML）とシナリオ記述 DSL
5. **可視化・UI 層**
   - Bevy/Tauri ベースの 3D ビューワ、ステータスダッシュボード
   - WebAssembly 経由のリモート UI
   - センサ可視化（LiDAR, IMU, カメラ、人工ノイズ付与）

5. 主要機能ブロック
-------------------
- **プロジェクト管理**: シミュレーション構成を `.speckit` プロジェクトファイルで定義し、依存アセットを束ねる。
- **モデルビルダー**: CAD/URDF インポート、慣性テンプレート、材質ライブラリ。
- **動力学シミュレータ**: 剛体・柔軟部材・接触・流体抵抗、複数積分器 (Semi-implicit Euler, Runge-Kutta)。
- **制御スタック**: PID/MPPI/MPC などの制御モジュール、センサフィードバック、遅延・量子化など実装誤差の注入。
- **テストハーネス**: シナリオスクリプト、評価指標 (例: バッテリ消費、ゴール到達時間)、自動レポート生成。
- **拡張 API**: Rust crate / Python package / C ABI によるプラグイン登録。

6. 品質基準・検証方針
--------------------
- **物理妥当性**: 既知の解析解・実機ログとの比較テストスイートを整備し、主要メトリクスの誤差率を常時計測。
- **パフォーマンス**: 1 ms 未満の制御周期を安定維持できるターゲットモデル（例: 12 自由度ロボット）で 60 FPS を維持。
- **安定性**: 長時間 (>= 1 時間) シミュレーションで NaN/発散が発生しないことを CI で確認。
- **拡張安全性**: プラグインはサンドボックスで実行し、リソース使用量を監視。FFI レイヤの API はバージョン付与する。
- **ドキュメント**: API Reference、チュートリアル、Cookbook、FAQ を整備。ドキュメントもバージョン管理。

7. ロードマップ（目安）
-----------------------
### Phase 0: 基礎調査 (0～2 ヶ月)
- 既存エンジン比較、ベンチマーク計測、ロボコン固有要件の整理。
- PoC: MuJoCo + Rust FFI で単体剛体の制御ループを動かす。

### Phase 1: 最小実用セット (3～6 ヶ月)
- 基本的なロボットモデル（4 輪 / 2 輪 / アーム）テンプレート。
- 制御 I/F（C, Python）と Arduino 用 SIL を実装。
- ログ収集と簡易ビューワ。

### Phase 2: 実戦投入レベル (6～12 ヶ月)
- リンク柔軟性・ケーブル駆動など非線形要素の追加。
- CAD からの半自動モデル生成、LiDAR/カメラセンサのレンダリング。
- UI プロトタイプ（Tauri + Bevy）、シナリオエディタ。

### Phase 3: 拡張・コミュニティ (12 ヶ月～)
- プラグインマーケットプレイス、シナリオ共有機能。
- Web 監視ダッシュボード、コンペ競技向けテンプレート。
- 分散シミュレーション（複数マシン、クラウド対応）の検証。

8. 技術スタック（初期案）
-------------------------
- Rust 1.80+ / Cargo ワークスペース構成
- 主要依存: `bevy`, `bevy_rapier3d`, `mujoco-sys`, `nalgebra`, `serde`, `tokio`, `thiserror`, `tracing`
- Python 連携: `pyo3`, `maturin`
- UI: `Tauri`, `React`, `TypeScript`, `Tailwind CSS`, `shadcn/ui`
- DevOps: GitHub Actions, `cargo fmt`, `cargo clippy`, `just` タスクランナー

9. ガバナンスと開発プロセス
---------------------------
- **ブランチ戦略**: `main` (安定) / `develop` / feature ブランチ。非互換 API 変更は RFC プロセスを必須化。
- **Issue 分類**: `design`, `physics`, `control`, `ui`, `infra`, `docs`, `good-first-issue`.
- **レビュー**: FFI を含む PR はダブルレビュー必須。シミュレーション結果に影響する変更は再現用ログを添付。
- **コミュニティ**: Discord / Forum を設置し、テンプレートやサンプルモデルを共有。ロボコン OB・研究者とのアドバイザリーボードを組成。

10. 非目標（当面扱わない範囲）
-----------------------------
- 実環境の完全再現（気象・広域マップなど）は範囲外。必要に応じ他エンジンと連携。
- 高速フル GPU 物理シミュレーションの独自実装。既存ライブラリ活用を優先。
- 汎用ゲームエンジンとしての利用。ロボティクス特化を貫く。
- フルクラウド SaaS 化。オンプレ／デスクトップ優先で検証。

11. 成功条件の定義
------------------
- 3 校以上のロボコンチームが Speckit を用いて機構・制御の意思決定を完了したという証跡を得る。
- 実機試作前に主要不具合（例: モータ出力不足、干渉、制御不安定）が検出された事例を複数報告。
- コアライブラリのクラッシュバグ報告が 1 シーズン (6 ヶ月) で 3 件以下に収束。

12. 次アクション
---------------
1. Phase 0 の調査トラックを開始し、MuJoCo 連携 PoC の技術検証項目を洗い出す。
2. ペルソナ／ユースケースを詳細化し、最小機能セット (MVP) の要件を Issue 化する。
3. CAD インポートと制御 I/F の PoC を分担し、技術チャレンジと必要リソースを整理する。
